<!-- DFB pg. 175 -->
{% extends "base_with_sidebar.html" %}

{% block title %}Dashboard{% endblock title %}
{% block css %}
{% load static %}
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<link rel="stylesheet" type="text/css" href=" {% static '/css/posts/dashboard.css' %} ">
<link rel="stylesheet" type="text/css" href=" {% static '/css/flex.css' %} ">
<script src="{% static '/js/post_popup.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Script for handling ajax of button presses -->
<script>
    $(document).ready(function () {
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        $(".like-button").click(function () {
            var post_json = $(this).siblings(".post-data").text(); // get the corresponding post as json from the html
            var post = JSON.parse(post_json); //parse the json into an object
            var likeButtonData = $(this).siblings(".like-button-data");
            var likeButtonAlreadyPressed = likeButtonData.data('already-pressed-this-session');

            if (!likeButtonAlreadyPressed){
                $.ajax({
                    //Send the post data to the backend using a POST command, and specify content is json
                    url: '{% url "like_post" %}',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ post: post }),
                    headers: { 'X-CSRFToken': csrfToken }, //include authentication token

                    //Handle the response data from the server, and update the corresponding like count on the webpage
                    success: function (data) {
                        // Update the like count using the returned value (from the backend)
                        likeButtonData.data('already-pressed-this-session', 'true'); //log that the like button has already been pressed this session
                        $('#result-' + post.uuid).text(data.new_post_count); //Update the like count with whatever the backend returns
                    }
                });
            }
        });

        $(".comment-button").click(function () {
            var post_json = $(this).siblings(".post-data").text(); // get the corresponding post as json from the html
            var post = JSON.parse(post_json); //parse the json into an object
            var commentContainer = $("#comment-box-container-" + post.uuid + " .scrollable-comments");

            // Get existing comments for this post, and load them into the comments container
            $.ajax({
                    url: '{% url "open_comments" %}',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ post: post }),
                    headers: { 'X-CSRFToken': csrfToken }, //include authentication token
                    success: function (data) {
                        // the backend returns all comments for a post. Here we display them (add them into a container)
                        var comments = JSON.parse(data.comments);
                        commentContainer.empty();
                        // TODO: Store a link to the commenter's inbox after receiving the comment
                        
                        // Add the comment elements to the page
                        comments.forEach(function (comment) {
                            comment_uuid = comment.id;
                            if (comment_uuid.endsWith("/")) {
                                comment_uuid = comment_uuid.slice(0, -1);
                            }
                            comment_uuid = comment_uuid.substring(comment_uuid.lastIndexOf("/") + 1);

                            var commentElement = '<div class="comment">' +
                                '<img src="' + comment.author.profileImage + '" class="comment-profile-picture" alt="Profile Picture">' +
                                '<div class="comment-details">' +
                                    '<p class="comment-username">' + comment.author.displayName + '</p>' +
                                    '<p class="comment-text">' + comment.comment + '</p>' +
                                '</div>' +
                                '<button class="like-comment-button" data-comment-uuid="' + comment_uuid + '">Like</button>' +
                            '</div>';
                            commentContainer.append(commentElement);
                        });

                        $("#comment-box-container-" + post.uuid).show();
                    
                    },
                    error: function (data) {
                        alert("Error fetching comments. Please try again.");
                    }
                });
        });

        $(".cancel-comment-button").click(function () {
            var post_uuid = $(this).data("post-uuid");
            $("#comment-box-container-" + post_uuid).hide();
        });

        $(document).on('click', '.like-comment-button', function () {
            var post_json = $(this).closest('.post-container').find(".comment-post-data").text();
            var post = JSON.parse(post_json); //parse the json into an object
            var comment_uuid = $(this).data("comment-uuid");

            // Use ajax to get backend to send a like to a comment
            $.ajax({
                    url: '{% url "like_comment" %}',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ post: post, comment_uuid: comment_uuid }),
                    headers: { 'X-CSRFToken': csrfToken }, //include authentication token
                    success: function (data) {
                        console.log("returned from like comment handler")

                    
                    },
                    error: function (data) {
                        alert("Error liking comment. Please try again.");
                    }
                });

        });

        $(".submit-comment-button").click(function () {
            var post_json = $(this).siblings(".comment-post-data").text(); // get the corresponding post as json from the html
            var post = JSON.parse(post_json); //parse the json into an object
            var commentText = $("#comment-textbox-" + post.uuid).val(); // Get the comment text from the text box
            var commentContainer = $("#comment-box-container-" + post.uuid + " .scrollable-comments");

            if (commentText.trim() !== "") {
                $.ajax({
                    url: '{% url "submit_comment" %}',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 
                        post: post, 
                        comment_text: commentText
                    }),
                    headers: { 'X-CSRFToken': csrfToken }, //include authentication token
                    success: function (data) {
                        // Here we read the list of all comments from the db that perfectly match the comment just submitted (this will only be one comment, but for the sake of using the same code as above, we kept this structure)
                        // Once we get the new comment from the db, we add it to the comments displayed
                        var comments = JSON.parse(data.comments);
                        // Add the comment element to the page
                        comments.forEach(function (comment) {
                            var commentElement = '<div class="comment">' +
                                '<img src="' + comment.author.profileImage + '" class="comment-profile-picture" alt="Profile Picture">' +
                                '<div class="comment-details">' +
                                    '<p class="comment-username">' + comment.author.displayName + '</p>' +
                                    '<p class="comment-text">' + comment.comment + '</p>' +
                                '</div>' +
                                '<button class="like-comment-button" data-comment-uuid="' + comment.uuid + '">Like</button>' +
                            '</div>';
                            commentContainer.append(commentElement);
                        });
                        $("#comment-textbox-" + post_uuid).val(''); // Clear the contents of the textbox after successfully adding the comment
                    },
                    error: function (data) {
                        alert("Error submitting comment. Please try again.");
                    }
                });
            }
            else {
                alert("Please enter text before submitting a comment.");
            }
        });

        
        
        $(".authorDetails").click(function () {
            
            var csrfToken = $('meta[name=csrf-token]').attr('content');
            var get_url = $(this).data("get-url");
            var host = $(this).data("host");

            $.ajax({
                url: "/authors/profile/determine-args/",
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                data: {
                    get_url: get_url,
                    host : host,
                },
                success: function(data) {
                    json_data = JSON.parse(data);
                    // console.log(json_data.host_index);
                    var index = json_data.host_index;
                    var uuid = json_data.uuid;
                    window.location.href = "/authors/" + index + "/" + uuid + "/";
                },
                error: function(data) {
                    console.log("error");
                }
            });

        });

        $(".delete-confirm").click(function () {
            var post_uuid = $(this).data("post-uuid"); // Get the post ID from the button's data attribute
            var author_uuid = $(this).data("author-uuid");
            $.ajax({
                url: "/posts/" + post_uuid + "/delete",
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(data) {
                    location.reload();
                    $("#modal").hide();
                },
                error: function(data) {
                    console.log("error");
                }
            });
            
        });
    });

</script>



</script>
<!-- <script src="{% static '/js/like_button.js' %}"></script> -->

{% endblock css %}

{% block content %}

<!-- TODO: This is a security risk as all posts are sent to the browser (potentially including non-authorized ones). Edit this so that we only send authorized posts from the server -->
{% for post in all_posts %}
    {% if not post.unlisted %}
        <div class="post-container">
            <div class="post" style="margin-top:3em">
                <section id="post_author">
                    <div class="authorDetails" data-get-url="{{ post.author.id }}" data-host="{{ post.author.host }}">
                        <img src="{{ post.author.profileImage }}" href="{% static 'css/main.css' %}" class="profile_picture"></img>
                        <p style="margin: 0; margin-left:0.25em; margin-top: 0.25em; color:black; font-size:24px; user-select: none">{{ post.author.displayName}}</p>
                    </div>
                    <div class="flex_grow"></div>
                    <p style="align-self: end;">{{ post.delta }}</p>
                </section>
                <section id="post_body">
                    <h1>{{ post.title }}</h1>
                    {% if post.contentType == "text/plain" or post.contentType == "text/markdown" %}
                        {{ post.content|safe }}
                    {% endif %}
                </section>
                {% if post.contentType == "application/base64" or post.contentType == "image/jpeg;base64" or post.contentType == "image/png;base64" %}
                    <div style=" margin-bottom:2px;" >
                        <img class="postImage" src="data:{{ post.contentType }},{{ post.content }}" alt="Image for {{ post.title }}" />
                    </div>
                {% endif %}
                <div class="flex_grow"></div>
                <div class="footer">
                    <span class="material-symbols-outlined" style="padding: 10px; font-size:33px;">thumb_up</span>
                    <p class="likes"id="result-{{ post.uuid }}">{{ post.likeCount}} </p>
                    <!-- Post like button -->
                    <button style="padding-top: 10px;" type="button"class="like-button"><i class="material-symbols-outlined">favorite</i></button>
                    <div class="post-data" style="display: none;">{{ post|json_script }}</div> <!-- create a hidden html element that contains the post data in json format. We will read this in our ajax handler for the like button -->
                    <div class="like-button-data" style="display: none;" data-already-pressed-this-session="false"></div>
                    <!-- comment button-->
                    <button style="padding-top: 10px;" type="button"class="comment-button"><i class="material-symbols-outlined">tooltip</i></button>
                    {% if user.username == post.author.displayName %} <!-- only allow users to update their own profiles; current user username must match that of author-->
                        <div class="flex_grow"></div>
                        <div class="context_menu" id="context_menu">
                            <div class="context_menu_item"><a href="{% url 'edit_post' post_uuid=post.uuid author_id=post.author_uuid %}"><i style="margin-right:5px;" class="material-symbols-outlined">edit</i>Edit</a></div>
                            <div class="context_menu_item"><i class="material-symbols-outlined">delete</i><button class="delete_button" id="delete-button" type="button">Delete</button></div>
                        </div>
                        <dialog class="modal" id="modal">
                            <div class="col-flex">
                            <p style="color:white; font-size: 32px;">Are you sure you want to delete this post?</p>
                            <div class="row-flex" style="justify-content: center; align-items: center;">
                                <button style="margin-right: 10px;" class="close-button" type="button">Cancel</button>
                                <button class="delete-confirm" data-post-uuid="{{ post.uuid }}" data-author-uuid="{{ post.author_uuid }}">Confirm</button>
                            </div>
                        </dialog>
                        <button style="padding-top: 10px;" id="context_opener" class="context_button"><i class="material-symbols-outlined" style="color:white">more_vert</i></button>
                    {% endif %}
                </div>
            </div>
            <div class="comment-box-container" id="comment-box-container-{{ post.uuid }}" style="display: none;">
                <div class="scrollable-comments">
                    <!-- comments are loaded into this container via the ajax script -->
                    <div class="comment">
                    </div>
                </div>
                <div class="submit-comment-box">
                    <textarea class="comment-textbox" id="comment-textbox-{{ post.uuid }}" placeholder="Leave a comment"></textarea>
                    <button class="cancel-comment-button" data-post-uuid="{{ post.uuid }}">Cancel</button>
                    <button class="submit-comment-button">Submit</button>
                    <div class="comment-post-data" style="display: none;">{{ post|json_script }}</div> <!-- create a hidden html element that contains the post data in json format. We will read this in our ajax handler for the submit comment button -->
                </div>  
            </div>
        </div>
    {% endif %}


{% empty %}
    <div style="padding:10px;">
        <h1 style="text-align: center;">Looks like there's no posts available. Why not make one?</h1>
        <div style="text-align: center;"><a href="{% url 'new_post' %}" class="no_post_button">Make a Post</a></div>
        <div class="flex_grow"></div>
    </div>
{% endfor %}

<script>
    // https://www.youtube.com/watch?v=TAB_v6yBXIE
    const context_menus = document.querySelectorAll(".context_menu");
    const context_openers = document.querySelectorAll(".context_button");

    for (let i = 0; i < context_openers.length; i++) {
        const opener = context_openers[i];
        const menu = context_menus[i];

        opener.addEventListener("click", () => {
            const computedStyle = getComputedStyle(menu);
            if (computedStyle.visibility == "visible") {
                menu.style.visibility = "hidden";
            }
            else {
                menu.style.visibility = "visible";
            }
        });
    };

    const open_modals = document.querySelectorAll(".delete_button");
    const modals = document.querySelectorAll(".modal");
    const close_modals = document.querySelectorAll(".close-button");

    for (let i = 0; i < open_modals.length; i++) {
        const open_modal = open_modals[i];
        const modal = modals[i];
        const close_modal = close_modals[i];

        open_modal.addEventListener("click", () => {
            modal.showModal();
        });

        close_modal.addEventListener("click", () => {
            modal.close();
        });
    };
</script>

{% endblock content %}
