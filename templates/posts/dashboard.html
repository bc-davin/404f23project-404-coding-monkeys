<!-- DFB pg. 175 -->
{% extends "base_with_sidebar.html" %}

{% block title %}Dashboard{% endblock title %}
{% block css %}
{% load static %}
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<link rel="stylesheet" type="text/css" href=" {% static '/css/posts/dashboard.css' %} ">
<link rel="stylesheet" type="text/css" href=" {% static '/css/flex.css' %} ">
<script src="{% static '/js/post_popup.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Script for handling ajax of button presses -->
<script>
    $(document).ready(function () {
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        $(".like-button").click(function () {
            var post_uuid = $(this).data("post-uuid"); // Get the post ID from the button's data attribute
            $.ajax({
                url: '{% url "like_post" %}',
                method: 'GET',
                data: { post_uuid: post_uuid }, // Pass the post UUID as a parameter
                success: function (data) {
                    // Update the like count
                    $('#result-' + post_uuid).text(data.new_post_count);
                }
            });
        });

        $(".comment-button").click(function () {
            var post_uuid = $(this).data("post-uuid");
            $("#comment-box-container-" + post_uuid).toggle(); //Make the text box appear
            // TODO: Make textbox disappear when pressing submit?
            // TODO: Make cancel button the only way to hide text box?
        });

        $(".submit-comment-button").click(function () {
            var post_uuid = $(this).data("post-uuid"); // Get the post ID from the button's data attribute
            var commentText = $("#comment-textbox-" + post_uuid).val(); // Get the text from the textarea

            // TODO: Handle empty comments

            // Handle comment submission logic here
            $.ajax({
                url: '{% url "comment_post" %}',
                method: 'GET',
                data: { 
                    post_uuid: post_uuid,
                    comment_text: commentText // Include comment text in the data
                }, 
                success: function (data) {
                    // Will likely want to return a list of the comments on this post, and we will print them here
                    // $('#result-' + post_uuid).text(data.new_post_count); //this was for likes, not comments
                }
            });
        });

        $(".delete-confirm").click(function () {
            var post_uuid = $(this).data("post-uuid"); // Get the post ID from the button's data attribute
            var author_uuid = $(this).data("author-uuid");
            $.ajax({
                url: "/authors/" + author_uuid + "/posts/" + post_uuid,
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(data) {
                    location.reload();
                    $("#modal").hide();
                },
                error: function(data) {
                    console.log("error");
                }
            });
            
        });
    });

</script>



</script>
<!-- <script src="{% static '/js/like_button.js' %}"></script> -->

{% endblock css %}

{% block content %}

<!-- TODO: This is a security risk as all posts are sent to the browser (potentially including non-authorized ones). Edit this so that we only send authorized posts from the server -->
{% for post in all_posts %}
    {% if not post.unlisted %}
        <div class="post" style="margin-top:3em">
            <section id="post_author">
                <img src="{{ post.author.profileImage }}" href="{% static 'css/main.css' %}" class="profile_picture"></img>
                <a href="{% url 'author_profile' uuid=post.author.id %}">{{ post.author.displayName}}</a>
                <div class="flex_grow"></div>
                <p style="align-self: end;">{{ post.published }}</p>
            </section>
            <section id="post_body">
                <h1>{{ post.title }}</h1>
                <p class="body_style">{{ post.content }}</p>
            </section>
            {% for image in all_posts %}
                {% if image.uuid == post.uuid|add:"_pic" %}
                <!-- for each post, look if there is a corresponding pic post in the list of all posts. If there is, display it along with the parent post -->
                    <section id="post_image">
                        <img style="padding-left: 10px;" src="data:{{ image.contentType }},{{ image.content }}" alt="Image for {{ post.title }}" />
                    </section>
                {% endif %}
            {% endfor %}
            <div class="flex_grow"></div>
            <div class="footer">
                <span class="material-symbols-outlined" style="padding: 10px; font-size:33px;">thumb_up</span>
                <p class="likes"id="result-{{ post.uuid }}">{{ post.count}} </p>
                <!-- https://www.w3schools.com/howto/howto_css_icon_buttons.asp -->
                <button style="padding-top: 10px;" type="button"class="like-button" data-post-uuid="{{ post.uuid }}"><i class="material-symbols-outlined">favorite</i></button>
                <!-- comment button-->
                <button style="padding-top: 10px;" type="button"class="comment-button" data-post-uuid="{{ post.uuid }}"><i class="material-symbols-outlined">tooltip</i></button>
                {% if user.username == post.author.displayName %} <!-- only allow users to update their own profiles; current user username must match that of author-->
                    <div class="flex_grow"></div>
                    <div class="context_menu" id="context_menu">
                        <div class="context_menu_item"><a href="{% url 'edit_post' post_uuid=post.uuid author_id=post.author.id %}"><i style="margin-right:5px;" class="material-symbols-outlined">edit</i>Edit</a></div>
                        <div class="context_menu_item"><i class="material-symbols-outlined">delete</i><button class="delete_button" id="delete-button" type="button">Delete</button></div>
                    </div>
                    <dialog class="modal" id="modal">
                        <div class="col-flex">
                        <p style="color:white; font-size: 32px;">Are you sure you want to delete this post?</p>
                        <div class="row-flex" style="justify-content: center; align-items: center;">
                            <button style="margin-right: 10px;" class="close-button" type="button">Cancel</button>
                            <button class="delete-confirm" data-post-uuid="{{ post.uuid }}" data-author-uuid="{{ post.author.id }}">Confirm</button>
                        </div>
                    </dialog>
                    <button style="padding-top: 10px;" id="context_opener" class="context_button"><i class="material-symbols-outlined" style="color:white">more_vert</i></button>
                {% endif %}
            </div>
            <div class="comment-box-container" id="comment-box-container-{{ post.uuid }}" style="display: none;">
                <textarea class="comment-textbox" id="comment-textbox-{{ post.uuid }}" placeholder="Leave a comment"></textarea>
                <button class="submit-comment-button" data-post-uuid="{{ post.uuid }}">Submit</button>
            </div>
        </div>
    {% endif %}

{% empty %}
    <div style="padding:10px;">
        <h1 style="text-align: center;">Looks like there's no posts available. Why not make one?</h1>
        <div style="text-align: center;"><a href="{% url 'new_post' %}" class="no_post_button">Make a Post</a></div>
        <div class="flex_grow"></div>
    </div>
{% endfor %}

<script>
    // https://www.youtube.com/watch?v=TAB_v6yBXIE
    const context_menus = document.querySelectorAll(".context_menu");
    const context_openers = document.querySelectorAll(".context_button");

    for (let i = 0; i < context_openers.length; i++) {
        const opener = context_openers[i];
        const menu = context_menus[i];

        opener.addEventListener("click", () => {
            const computedStyle = getComputedStyle(menu);
            if (computedStyle.visibility == "visible") {
                menu.style.visibility = "hidden";
            }
            else {
                menu.style.visibility = "visible";
            }
        });
    };

    const open_modals = document.querySelectorAll(".delete_button");
    const modals = document.querySelectorAll(".modal");
    const close_modals = document.querySelectorAll(".close-button");

    for (let i = 0; i < open_modals.length; i++) {
        const open_modal = open_modals[i];
        const modal = modals[i];
        const close_modal = close_modals[i];

        open_modal.addEventListener("click", () => {
            modal.showModal();
        });

        close_modal.addEventListener("click", () => {
            modal.close();
        });
    };
</script>

{% endblock content %}
